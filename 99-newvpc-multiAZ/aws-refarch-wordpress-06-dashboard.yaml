---
AWSTemplateFormatVersion: 2010-09-09

Description: Creates CloudWatch Dashboard

Metadata:

  Authors:
    Description: James Radtke (jaradtke@amazon.com)
  License:
    Description: ' '

  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: AWS Resource Parameters
      Parameters:
        - PublicAlbFullName
        - BurstCreditBalanceDecreaseAlarmArn
        - BurstCreditBalanceIncreaseAlarmArn
        - CriticalAlarmArn
        - WarningAlarmArn
        - CreateAlarms
    ParameterLabels:
      BurstCreditBalanceDecreaseAlarmArn:
        default: Decrease Alarm Arn
      BurstCreditBalanceIncreaseAlarmArn:
        default: Increase Alarm Arn
      CriticalAlarmArn:
        default: Critical Alarm Arn
      PublicAlbFullName:
        default: Amazon ALB Full Name
      WarningAlarmArn:
        default: Warning Alarm Arn
      CreateAlarms:
        default: Create Alarms

Parameters:

  CreateAlarms:
    AllowedValues:
      - true
      - false
    Default: true
    Description: Create Alarms, or no
    Type: String
  BurstCreditBalanceDecreaseAlarmArn:
    Default: ''
    Description: Amazon EFS Burst Credit Balance Decrease Alarm Arn
    Type: String
  BurstCreditBalanceIncreaseAlarmArn:
    Default: ''
    Description: Amazon EFS Burst Credit Balance Increase Alarm Arn
    Type: String
  CriticalAlarmArn:
    Default: ''
    Description: Amazon EFS Burst Credit Balance Critical Alarm Arn
    Type: String
  PublicAlbFullName:
    Description: Amazon ALB Full Name
    Type: String
  WarningAlarmArn:
    Default: ''
    Description: Amazon EFS Burst Credit Balance Warning Alarm Arn
    Type: String

Resources:

  DashboardWithAlarms:
    Condition: Alarms
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Join [ '_', [ !Ref 'AWS::Region', !Ref 'AWS::StackName' ] ]
      DashboardBody:
        {"Fn::Join":
          [ "",
          [ 
            '{"widgets": [
                  {
                      "type": "metric",
                      "x": 0,
                      "y": 12,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "view": "timeSeries",
                          "stacked": false,
                          "metrics": [
                              [ "AWS/ApplicationELB", "RequestCount", "LoadBalancer", "',!Ref 'PublicAlbFullName','", { "stat": "Sum", "period": 60 } ]
                          ],
                          "region": "',!Ref 'AWS::Region','",
                          "title": "ALB RequestCount"
                      }
                  },
                  {
                      "type": "metric",
                      "x": 6,
                      "y": 12,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "view": "timeSeries",
                          "stacked": false,
                          "metrics": [
                              [ "AWS/ApplicationELB", "ActiveConnectionCount", "LoadBalancer", "',!Ref 'PublicAlbFullName','", { "stat": "Sum", "period": 60 } ]
                          ],
                          "region": "',!Ref 'AWS::Region','",
                          "title": "ALB ActiveConnectionCount"
                      }
                  },
                  {
                      "type": "metric",
                      "x": 0,
                      "y": 6,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "title": "EFS Burst Credit Balance Increase Threshold",
                          "annotations": {
                              "alarms": [
                                  "',!Ref 'BurstCreditBalanceIncreaseAlarmArn','"
                              ]
                          },
                          "view": "timeSeries",
                          "stacked": false
                      }
                  }
              ]
            }'
          ]
          ]
        }
  DashboardWithNoAlarms:
    Condition: NoAlarms
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Join [ '_', [ !Ref 'AWS::Region', !Ref 'AWS::StackName' ] ]
      DashboardBody:
        {"Fn::Join":
          [ "",
          [ 
            '{"widgets": [
                  {
                      "type": "metric",
                      "x": 0,
                      "y": 12,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "view": "timeSeries",
                          "stacked": false,
                          "metrics": [
                              [ "AWS/ApplicationELB", "RequestCount", "LoadBalancer", "',!Ref 'PublicAlbFullName','", { "stat": "Sum", "period": 60 } ]
                          ],
                          "region": "',!Ref 'AWS::Region','",
                          "title": "ALB RequestCount"
                      }
                  },
                  {
                      "type": "metric",
                      "x": 6,
                      "y": 12,
                      "width": 6,
                      "height": 6,
                      "properties": {
                          "view": "timeSeries",
                          "stacked": false,
                          "metrics": [
                              [ "AWS/ApplicationELB", "ActiveConnectionCount", "LoadBalancer", "',!Ref 'PublicAlbFullName','", { "stat": "Sum", "period": 60 } ]
                          ],
                          "region": "',!Ref 'AWS::Region','",
                          "title": "ALB ActiveConnectionCount"
                      }
                  }
              ]
            }'
          ]
          ]
        }

Conditions:
  Alarms:
    !Equals [ !Ref CreateAlarms, true ]
  NoAlarms:
    !Equals [ !Ref CreateAlarms, false ]
